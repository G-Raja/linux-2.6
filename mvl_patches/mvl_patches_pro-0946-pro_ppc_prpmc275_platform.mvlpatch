#! /usr/bin/env bash
# Patch: -pro_ppc_prpmc275_platform
# Date: Wed Oct 11 21:58:50 2006
# Source: MontaVista Software, Inc.
# MR: 19269
# Type: Enhancement 
# Disposition: needs submitting to linuxppc-embedded mailing list
# Signed-off-by: Vladimir Barinov <vbarinov@ru.mvista.com>
# Description:
#     Motorola PrPMC275 board support in 2.6
# 
#  arch/ppc/Kconfig                     |    7 
#  arch/ppc/Kconfig.debug               |    3 
#  arch/ppc/boot/simple/Makefile        |    6 
#  arch/ppc/boot/simple/misc-prpmc275.c |   33 +
#  arch/ppc/configs/prpmc275_defconfig  | 1034 +++++++++++++++++++++++++++++++++++
#  arch/ppc/platforms/Makefile          |    1 
#  arch/ppc/platforms/prpmc275.c        |  817 +++++++++++++++++++++++++++
#  arch/ppc/platforms/prpmc275.h        |   91 +++
#  arch/ppc/syslib/Makefile             |    1 
#  9 files changed, 1990 insertions(+), 3 deletions(-)
# 

PATCHNUM=946
LSPINFO=include/linux/lsppatchlevel.h
TMPFILE=/tmp/mvl_patch_$$

function dopatch() {
    patch $* >${TMPFILE} 2>&1 <<"EOF"
Source: MontaVista Software, Inc.
MR: 19269
Type: Enhancement 
Disposition: needs submitting to linuxppc-embedded mailing list
Signed-off-by: Vladimir Barinov <vbarinov@ru.mvista.com>
Description:
    Motorola PrPMC275 board support in 2.6

 arch/ppc/Kconfig                     |    7 
 arch/ppc/Kconfig.debug               |    3 
 arch/ppc/boot/simple/Makefile        |    6 
 arch/ppc/boot/simple/misc-prpmc275.c |   33 +
 arch/ppc/configs/prpmc275_defconfig  | 1034 +++++++++++++++++++++++++++++++++++
 arch/ppc/platforms/Makefile          |    1 
 arch/ppc/platforms/prpmc275.c        |  817 +++++++++++++++++++++++++++
 arch/ppc/platforms/prpmc275.h        |   91 +++
 arch/ppc/syslib/Makefile             |    1 
 mvl_patches/pro-0946.c               |   16 
 10 files changed, 2006 insertions(+), 3 deletions(-)

Index: linux-2.6.10/arch/ppc/Kconfig
===================================================================
--- linux-2.6.10.orig/arch/ppc/Kconfig
+++ linux-2.6.10/arch/ppc/Kconfig
@@ -638,6 +638,9 @@ config MVME5100
 config PPLUS
 	bool "Motorola-PowerPlus"
 
+config PRPMC275
+	bool "Motorola-PrPMC275"
+
 config PRPMC750
 	bool "Motorola-PrPMC750"
 
@@ -842,7 +845,7 @@ config GT64260
 
 config MV64360
 	bool
-	depends on KATANA
+	depends on KATANA || PRPMC275
 	default y
 
 config MV64360
@@ -886,7 +889,7 @@ endmenu
 
 config NONMONARCH_SUPPORT
 	bool "Enable Non-Monarch Support"
-	depends on PRPMC800
+	depends on (PRPMC800 || PRPMC275)
 
 config HARRIER
 	bool
Index: linux-2.6.10/arch/ppc/Kconfig.debug
===================================================================
--- linux-2.6.10.orig/arch/ppc/Kconfig.debug
+++ linux-2.6.10/arch/ppc/Kconfig.debug
@@ -26,7 +26,8 @@ config BOOTX_TEXT
 
 config SERIAL_TEXT_DEBUG
 	bool "Support for early boot texts over serial port"
-	depends on 4xx || GT64260 || LOPEC || PPLUS || PRPMC800 || PPC_GEN550 || PPC_MPC52xx
+	depends on 4xx || GT64260 || LOPEC || PPLUS || PRPMC800 || \
+	        PPC_GEN550 || PPC_MPC52xx || PRPMC275
 
 config PPC_OCP
 	bool
Index: linux-2.6.10/arch/ppc/boot/simple/Makefile
===================================================================
--- linux-2.6.10.orig/arch/ppc/boot/simple/Makefile
+++ linux-2.6.10/arch/ppc/boot/simple/Makefile
@@ -113,6 +113,12 @@ zimageinitrd-$(CONFIG_GEMINI)		:= zImage
          end-$(CONFIG_KATANA)		:= katana
    cacheflag-$(CONFIG_KATANA)		:= -include $(clear_L2_L3)
 
+      zimage-$(CONFIG_PRPMC275)		:= zImage-STRIPELF
+zimageinitrd-$(CONFIG_PRPMC275)		:= zImage.initrd-STRIPELF
+     extra.o-$(CONFIG_PRPMC275)		:= misc-prpmc275.o
+         end-$(CONFIG_PRPMC275)		:= prpmc275
+   cacheflag-$(CONFIG_PRPMC275)		:= -include $(clear_L2_L3)
+
 # kconfig 'feature', only one of these will ever be 'y' at a time.
 # The rest will be unset.
 motorola := $(CONFIG_MCPN765)$(CONFIG_MVME5100)$(CONFIG_PRPMC750) \
Index: linux-2.6.10/arch/ppc/boot/simple/misc-prpmc275.c
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/boot/simple/misc-prpmc275.c
@@ -0,0 +1,33 @@
+/*
+ * arch/ppc/boot/simple/misc-prpmc275.c
+ *
+ * Set up MPSC values to bootwrapper can prompt user.
+ *
+ * Author: Vladimir A. Barinov <vbarinov@ru.mvista.com>
+ *
+ * Based on code done by Mark A. Greer <mgreer@mvista.com>
+ *
+ * 2006 (c) MontaVista Software, Inc.  This file is licensed under
+ * the terms of the GNU General Public License version 2.  This program
+ * is licensed "as is" without any warranty of any kind, whether express
+ * or implied.
+ */
+
+#include <linux/types.h>
+#include <platforms/prpmc275.h>
+
+#ifdef CONFIG_SERIAL_MPSC_CONSOLE
+extern u32 mv64x60_console_baud;
+extern u32 mv64x60_mpsc_clk_src;
+extern u32 mv64x60_mpsc_clk_freq;
+#endif
+
+void
+mv64x60_board_init(void __iomem *old_base, void __iomem *new_base)
+{
+#ifdef CONFIG_SERIAL_MPSC_CONSOLE
+	mv64x60_console_baud = PPMC275_DEFAULT_BAUD;
+	mv64x60_mpsc_clk_src = PPMC275_MPSC_CLK_SRC;
+	mv64x60_mpsc_clk_freq = PPMC275_BUS_FREQ;
+#endif
+}
Index: linux-2.6.10/arch/ppc/configs/prpmc275_defconfig
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/configs/prpmc275_defconfig
@@ -0,0 +1,1034 @@
+#
+# Automatically generated make config: don't edit
+# Linux kernel version: 2.6.10_mvl401
+# Tue Jul 25 17:48:18 2006
+#
+CONFIG_MMU=y
+CONFIG_GENERIC_HARDIRQS=y
+CONFIG_RWSEM_GENERIC_SPINLOCK=y
+CONFIG_ASM_SEMAPHORES=y
+CONFIG_HAVE_DEC_LOCK=y
+CONFIG_PPC=y
+CONFIG_PPC32=y
+CONFIG_GENERIC_NVRAM=y
+
+#
+# Code maturity level options
+#
+CONFIG_EXPERIMENTAL=y
+CONFIG_CLEAN_COMPILE=y
+CONFIG_BROKEN_ON_SMP=y
+CONFIG_LOCK_KERNEL=y
+
+#
+# General setup
+#
+CONFIG_LOCALVERSION=""
+CONFIG_SWAP=y
+CONFIG_SYSVIPC=y
+CONFIG_SYSVIPC_SEMMNI=128
+CONFIG_SYSVIPC_SEMMSL=250
+CONFIG_POSIX_MQUEUE=y
+# CONFIG_BSD_PROCESS_ACCT is not set
+CONFIG_SYSCTL=y
+# CONFIG_AUDIT is not set
+CONFIG_LOG_BUF_SHIFT=14
+CONFIG_HOTPLUG=y
+CONFIG_KOBJECT_UEVENT=y
+CONFIG_IKCONFIG=y
+CONFIG_IKCONFIG_PROC=y
+CONFIG_EMBEDDED=y
+# CONFIG_KALLSYMS is not set
+# CONFIG_FUTEX is not set
+# CONFIG_EPOLL is not set
+# CONFIG_CC_OPTIMIZE_FOR_SIZE is not set
+CONFIG_SHMEM=y
+CONFIG_CC_ALIGN_FUNCTIONS=0
+CONFIG_CC_ALIGN_LABELS=0
+CONFIG_CC_ALIGN_LOOPS=0
+CONFIG_CC_ALIGN_JUMPS=0
+CONFIG_LTT_MAX_HANDLES=128
+# CONFIG_BOOT_FLIGHT_RECORDER is not set
+CONFIG_LOCKLESS=y
+CONFIG_BOOT_FLIGHT_BUFFERS=4
+CONFIG_BOOT_FLIGHT_SIZE=524288
+CONFIG_FLIGHT_PROC_BUFFERS=8
+CONFIG_FLIGHT_PROC_SIZE=8192
+CONFIG_NEWEV=y
+CONFIG_CSTM=y
+# CONFIG_TINY_SHMEM is not set
+
+#
+# Loadable module support
+#
+CONFIG_MODULES=y
+CONFIG_MODULE_UNLOAD=y
+CONFIG_MODULE_FORCE_UNLOAD=y
+CONFIG_OBSOLETE_MODPARM=y
+CONFIG_MODVERSIONS=y
+# CONFIG_MODULE_SRCVERSION_ALL is not set
+CONFIG_KMOD=y
+
+#
+# Processor
+#
+CONFIG_6xx=y
+# CONFIG_40x is not set
+# CONFIG_44x is not set
+# CONFIG_POWER3 is not set
+# CONFIG_POWER4 is not set
+# CONFIG_8xx is not set
+# CONFIG_E200 is not set
+# CONFIG_E500 is not set
+CONFIG_PPC_FPU=y
+# CONFIG_ALTIVEC is not set
+# CONFIG_TAU is not set
+# CONFIG_CPU_FREQ is not set
+CONFIG_PPC_STD_MMU=y
+CONFIG_NOT_COHERENT_CACHE=y
+
+#
+# Platform options
+#
+# CONFIG_PPC_MULTIPLATFORM is not set
+# CONFIG_APUS is not set
+# CONFIG_KATANA is not set
+# CONFIG_WILLOW is not set
+# CONFIG_TAIGA is not set
+# CONFIG_CPCI690 is not set
+# CONFIG_PCORE is not set
+# CONFIG_POWERPMC250 is not set
+# CONFIG_CHESTNUT is not set
+# CONFIG_SPRUCE is not set
+# CONFIG_EV64260 is not set
+# CONFIG_LOPEC is not set
+# CONFIG_MCPN765 is not set
+# CONFIG_MVME5100 is not set
+# CONFIG_PPLUS is not set
+CONFIG_PRPMC275=y
+# CONFIG_PRPMC750 is not set
+# CONFIG_PRPMC800 is not set
+# CONFIG_SANDPOINT is not set
+# CONFIG_ADIR is not set
+# CONFIG_K2 is not set
+# CONFIG_PAL4 is not set
+# CONFIG_GEMINI is not set
+# CONFIG_EST8260 is not set
+# CONFIG_SBC82xx is not set
+# CONFIG_SBS8260 is not set
+# CONFIG_RPX8260 is not set
+# CONFIG_TQM8260 is not set
+# CONFIG_ADS8272 is not set
+# CONFIG_PQ2FADS is not set
+# CONFIG_LITE5200 is not set
+# CONFIG_MPC834x_SYS is not set
+CONFIG_MV64360=y
+CONFIG_MV64X60=y
+
+#
+# Set bridge options
+#
+CONFIG_MV64X60_BASE=0xf1000000
+CONFIG_MV64X60_NEW_BASE=0xf1000000
+# CONFIG_NONMONARCH_SUPPORT is not set
+# CONFIG_SMP is not set
+# CONFIG_PREEMPT_NONE is not set
+# CONFIG_PREEMPT_VOLUNTARY is not set
+CONFIG_PREEMPT_DESKTOP=y
+# CONFIG_PREEMPT_RT is not set
+CONFIG_PREEMPT=y
+# CONFIG_PREEMPT_SOFTIRQS is not set
+# CONFIG_PREEMPT_HARDIRQS is not set
+# CONFIG_PREEMPT_RCU is not set
+# CONFIG_SPINLOCK_BKL is not set
+CONFIG_PREEMPT_BKL=y
+CONFIG_HIGHMEM=y
+CONFIG_HIGH_RES_TIMERS=y
+CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_MISC is not set
+CONFIG_CMDLINE_BOOL=y
+CONFIG_CMDLINE="console=ttyMM0,115200 ip=bootp root=/dev/nfs mtdparts=BOOTFLASH:1024k(boot)ro kgdbwait"
+
+#
+# Bus options
+#
+CONFIG_GENERIC_ISA_DMA=y
+CONFIG_PCI=y
+CONFIG_PCI_DOMAINS=y
+# CONFIG_PCI_LEGACY_PROC is not set
+CONFIG_PCI_NAMES=y
+
+#
+# PCCARD (PCMCIA/CardBus) support
+#
+# CONFIG_PCCARD is not set
+
+#
+# PC-card bridges
+#
+
+#
+# Advanced setup
+#
+# CONFIG_ADVANCED_OPTIONS is not set
+
+#
+# Default settings for advanced configuration options are used
+#
+CONFIG_HIGHMEM_START=0xfe000000
+CONFIG_LOWMEM_SIZE=0x30000000
+CONFIG_KERNEL_START=0xc0000000
+CONFIG_TASK_SIZE=0x80000000
+CONFIG_CONSISTENT_START=0xff100000
+CONFIG_CONSISTENT_SIZE=0x00200000
+CONFIG_BOOT_LOAD=0x00800000
+
+#
+# Device Drivers
+#
+
+#
+# Generic Driver Options
+#
+CONFIG_STANDALONE=y
+CONFIG_PREVENT_FIRMWARE_BUILD=y
+# CONFIG_FW_LOADER is not set
+
+#
+# Memory Technology Devices (MTD)
+#
+CONFIG_MTD=y
+# CONFIG_MTD_DEBUG is not set
+CONFIG_MTD_CONCAT=y
+CONFIG_MTD_PARTITIONS=y
+# CONFIG_MTD_REDBOOT_PARTS is not set
+CONFIG_MTD_CMDLINE_PARTS=y
+
+#
+# User Modules And Translation Layers
+#
+CONFIG_MTD_CHAR=y
+CONFIG_MTD_BLOCK=y
+# CONFIG_FTL is not set
+# CONFIG_NFTL is not set
+# CONFIG_INFTL is not set
+# CONFIG_RFD_FTL is not set
+
+#
+# RAM/ROM/Flash chip drivers
+#
+CONFIG_MTD_CFI=y
+CONFIG_MTD_JEDECPROBE=y
+CONFIG_MTD_GEN_PROBE=y
+CONFIG_MTD_CFI_ADV_OPTIONS=y
+CONFIG_MTD_CFI_NOSWAP=y
+# CONFIG_MTD_CFI_BE_BYTE_SWAP is not set
+# CONFIG_MTD_CFI_LE_BYTE_SWAP is not set
+CONFIG_MTD_CFI_GEOMETRY=y
+CONFIG_MTD_MAP_BANK_WIDTH_1=y
+# CONFIG_MTD_MAP_BANK_WIDTH_2 is not set
+CONFIG_MTD_MAP_BANK_WIDTH_4=y
+# CONFIG_MTD_MAP_BANK_WIDTH_8 is not set
+# CONFIG_MTD_MAP_BANK_WIDTH_16 is not set
+# CONFIG_MTD_MAP_BANK_WIDTH_32 is not set
+CONFIG_MTD_CFI_I1=y
+CONFIG_MTD_CFI_I2=y
+# CONFIG_MTD_CFI_I4 is not set
+# CONFIG_MTD_CFI_I8 is not set
+# CONFIG_MTD_OTP is not set
+CONFIG_MTD_CFI_INTELEXT=y
+CONFIG_MTD_CFI_AMDSTD=y
+CONFIG_MTD_CFI_AMDSTD_RETRY=0
+# CONFIG_MTD_CFI_STAA is not set
+CONFIG_MTD_CFI_UTIL=y
+# CONFIG_MTD_RAM is not set
+# CONFIG_MTD_ROM is not set
+# CONFIG_MTD_ABSENT is not set
+# CONFIG_MTD_XIP is not set
+
+#
+# Mapping drivers for chip access
+#
+# CONFIG_MTD_COMPLEX_MAPPINGS is not set
+CONFIG_MTD_PHYSMAP=y
+CONFIG_MTD_PHYSMAP_START=0xa0000000
+CONFIG_MTD_PHYSMAP_LEN=0x08000000
+CONFIG_MTD_PHYSMAP_BANKWIDTH=2
+CONFIG_MTD_MULTI_PHYSMAP=y
+CONFIG_MTD_MULTI_PHYSMAP_1_NAME="BOOTFLASH"
+CONFIG_MTD_MULTI_PHYSMAP_1_START=0xff800000
+CONFIG_MTD_MULTI_PHYSMAP_1_LEN=0x00100000
+CONFIG_MTD_MULTI_PHYSMAP_1_WIDTH=1
+CONFIG_MTD_MULTI_PHYSMAP_2_NAME=""
+CONFIG_MTD_MULTI_PHYSMAP_2_START=0x00000000
+CONFIG_MTD_MULTI_PHYSMAP_2_LEN=0x00000000
+CONFIG_MTD_MULTI_PHYSMAP_2_WIDTH=0
+CONFIG_MTD_MULTI_PHYSMAP_3_NAME=""
+CONFIG_MTD_MULTI_PHYSMAP_3_START=0x00000000
+CONFIG_MTD_MULTI_PHYSMAP_3_LEN=0x00000000
+CONFIG_MTD_MULTI_PHYSMAP_3_WIDTH=0
+CONFIG_MTD_MULTI_PHYSMAP_4_NAME=""
+CONFIG_MTD_MULTI_PHYSMAP_4_START=0x00000000
+CONFIG_MTD_MULTI_PHYSMAP_4_LEN=0x00000000
+CONFIG_MTD_MULTI_PHYSMAP_4_WIDTH=0
+# CONFIG_MTD_PLATRAM is not set
+
+#
+# Self-contained MTD device drivers
+#
+# CONFIG_MTD_PMC551 is not set
+# CONFIG_MTD_SLRAM is not set
+# CONFIG_MTD_PHRAM is not set
+# CONFIG_MTD_MTDRAM is not set
+# CONFIG_RAMTD is not set
+# CONFIG_MTD_BLKMTD is not set
+# CONFIG_MTD_BLOCK2MTD is not set
+
+#
+# Disk-On-Chip Device Drivers
+#
+# CONFIG_MTD_DOC2000 is not set
+# CONFIG_MTD_DOC2001 is not set
+# CONFIG_MTD_DOC2001PLUS is not set
+
+#
+# NAND Flash Device Drivers
+#
+# CONFIG_MTD_NAND is not set
+
+#
+# Parallel port support
+#
+# CONFIG_PARPORT is not set
+
+#
+# Plug and Play support
+#
+
+#
+# Block devices
+#
+# CONFIG_BLK_DEV_FD is not set
+# CONFIG_BLK_CPQ_DA is not set
+# CONFIG_BLK_CPQ_CISS_DA is not set
+# CONFIG_BLK_DEV_DAC960 is not set
+# CONFIG_BLK_DEV_UMEM is not set
+CONFIG_BLK_DEV_LOOP=y
+# CONFIG_BLK_DEV_CRYPTOLOOP is not set
+# CONFIG_BLK_DEV_NBD is not set
+# CONFIG_BLK_DEV_SX8 is not set
+CONFIG_BLK_DEV_RAM=y
+CONFIG_BLK_DEV_RAM_COUNT=16
+CONFIG_BLK_DEV_RAM_SIZE=8192
+CONFIG_BLK_DEV_INITRD=y
+CONFIG_INITRAMFS_SOURCE=""
+# CONFIG_LBD is not set
+# CONFIG_CDROM_PKTCDVD is not set
+
+#
+# IO Schedulers
+#
+CONFIG_IOSCHED_NOOP=y
+CONFIG_IOSCHED_AS=y
+CONFIG_IOSCHED_DEADLINE=y
+CONFIG_IOSCHED_CFQ=y
+
+#
+# ATA/ATAPI/MFM/RLL support
+#
+# CONFIG_IDE is not set
+
+#
+# SCSI device support
+#
+# CONFIG_SCSI is not set
+
+#
+# Multi-device support (RAID and LVM)
+#
+# CONFIG_MD is not set
+
+#
+# Fusion MPT device support
+#
+
+#
+# IEEE 1394 (FireWire) support
+#
+# CONFIG_IEEE1394 is not set
+
+#
+# I2O device support
+#
+# CONFIG_I2O is not set
+
+#
+# Macintosh device drivers
+#
+
+#
+# Networking support
+#
+CONFIG_NET=y
+
+#
+# Networking options
+#
+CONFIG_PACKET=y
+# CONFIG_PACKET_MMAP is not set
+# CONFIG_NETLINK_DEV is not set
+CONFIG_UNIX=y
+# CONFIG_NET_KEY is not set
+CONFIG_USE_POLICY_FWD=y
+CONFIG_INET=y
+CONFIG_IP_MULTICAST=y
+# CONFIG_IP_ADVANCED_ROUTER is not set
+CONFIG_IP_PNP=y
+# CONFIG_IP_PNP_DHCP is not set
+CONFIG_IP_PNP_BOOTP=y
+# CONFIG_IP_PNP_RARP is not set
+# CONFIG_NET_IPIP is not set
+# CONFIG_NET_IPGRE is not set
+# CONFIG_IP_MROUTE is not set
+# CONFIG_ARPD is not set
+CONFIG_SYN_COOKIES=y
+# CONFIG_INET_AH is not set
+# CONFIG_INET_ESP is not set
+# CONFIG_INET_IPCOMP is not set
+# CONFIG_INET_TUNNEL is not set
+CONFIG_IP_TCPDIAG=y
+# CONFIG_IP_TCPDIAG_IPV6 is not set
+
+#
+# IP: Virtual Server Configuration
+#
+# CONFIG_IP_VS is not set
+CONFIG_IPV6=m
+# CONFIG_IPV6_PRIVACY is not set
+# CONFIG_IPV6_ROUTER_PREF is not set
+# CONFIG_INET6_AH is not set
+# CONFIG_INET6_ESP is not set
+# CONFIG_INET6_IPCOMP is not set
+# CONFIG_INET6_TUNNEL is not set
+# CONFIG_IPV6_TUNNEL is not set
+# CONFIG_IPV6_ADVANCED_ROUTER is not set
+# CONFIG_IPV6_MIP6 is not set
+CONFIG_NETFILTER=y
+# CONFIG_NETFILTER_DEBUG is not set
+
+#
+# IP: Netfilter Configuration
+#
+# CONFIG_IP_NF_CONNTRACK is not set
+# CONFIG_IP_NF_CONNTRACK_MARK is not set
+# CONFIG_IP_NF_QUEUE is not set
+# CONFIG_IP_NF_IPTABLES is not set
+# CONFIG_IP_NF_ARPTABLES is not set
+# CONFIG_IP_NF_COMPAT_IPCHAINS is not set
+# CONFIG_IP_NF_COMPAT_IPFWADM is not set
+
+#
+# IPv6: Netfilter Configuration
+#
+# CONFIG_IP6_NF_QUEUE is not set
+# CONFIG_IP6_NF_IPTABLES is not set
+# CONFIG_IP6_NF_CONNTRACK is not set
+
+#
+# SCTP Configuration (EXPERIMENTAL)
+#
+# CONFIG_IP_SCTP is not set
+# CONFIG_ATM is not set
+# CONFIG_BRIDGE is not set
+# CONFIG_VLAN_8021Q is not set
+# CONFIG_DECNET is not set
+# CONFIG_LLC2 is not set
+# CONFIG_IPX is not set
+# CONFIG_ATALK is not set
+# CONFIG_X25 is not set
+# CONFIG_LAPB is not set
+# CONFIG_NET_DIVERT is not set
+# CONFIG_ECONET is not set
+# CONFIG_WAN_ROUTER is not set
+
+#
+# QoS and/or fair queueing
+#
+# CONFIG_NET_SCHED is not set
+# CONFIG_NET_CLS_ROUTE is not set
+
+#
+# Network testing
+#
+# CONFIG_NET_PKTGEN is not set
+# CONFIG_NETPOLL is not set
+# CONFIG_NET_POLL_CONTROLLER is not set
+# CONFIG_HAMRADIO is not set
+# CONFIG_IRDA is not set
+# CONFIG_BT is not set
+# CONFIG_IEEE80211 is not set
+CONFIG_NETDEVICES=y
+# CONFIG_DUMMY is not set
+# CONFIG_BONDING is not set
+# CONFIG_EQUALIZER is not set
+CONFIG_TUN=m
+
+#
+# ARCnet devices
+#
+# CONFIG_ARCNET is not set
+
+#
+# PHY device support
+#
+
+#
+# Ethernet (10 or 100Mbit)
+#
+# CONFIG_NET_ETHERNET is not set
+
+#
+# Broadcom network devices
+#
+# CONFIG_HND is not set
+
+#
+# Ethernet (1000 Mbit)
+#
+# CONFIG_ACENIC is not set
+# CONFIG_DL2K is not set
+# CONFIG_E1000 is not set
+# CONFIG_NS83820 is not set
+# CONFIG_HAMACHI is not set
+# CONFIG_YELLOWFIN is not set
+# CONFIG_R8169 is not set
+# CONFIG_SK98LIN is not set
+# CONFIG_TIGON3 is not set
+CONFIG_MV643XX_ETH=y
+CONFIG_MV643XX_ETH_0=y
+CONFIG_MV643XX_ETH_1=y
+# CONFIG_MV643XX_ETH_2 is not set
+
+#
+# Ethernet (10000 Mbit)
+#
+# CONFIG_IXGB is not set
+# CONFIG_S2IO is not set
+
+#
+# Token Ring devices
+#
+# CONFIG_TR is not set
+
+#
+# Wireless LAN (non-hamradio)
+#
+# CONFIG_NET_RADIO is not set
+
+#
+# Wan interfaces
+#
+# CONFIG_WAN is not set
+# CONFIG_FDDI is not set
+# CONFIG_HIPPI is not set
+CONFIG_PPP=m
+# CONFIG_PPP_MULTILINK is not set
+# CONFIG_PPP_FILTER is not set
+CONFIG_PPP_ASYNC=m
+CONFIG_PPP_SYNC_TTY=m
+CONFIG_PPP_DEFLATE=m
+# CONFIG_PPP_BSDCOMP is not set
+# CONFIG_PPPOE is not set
+# CONFIG_SLIP is not set
+# CONFIG_SHAPER is not set
+# CONFIG_NETCONSOLE is not set
+
+#
+# ISDN subsystem
+#
+# CONFIG_ISDN is not set
+
+#
+# Telephony Support
+#
+# CONFIG_PHONE is not set
+
+#
+# Input device support
+#
+CONFIG_INPUT=y
+
+#
+# Userland interfaces
+#
+CONFIG_INPUT_MOUSEDEV=y
+CONFIG_INPUT_MOUSEDEV_PSAUX=y
+CONFIG_INPUT_MOUSEDEV_SCREEN_X=1024
+CONFIG_INPUT_MOUSEDEV_SCREEN_Y=768
+# CONFIG_INPUT_JOYDEV is not set
+# CONFIG_INPUT_TSDEV is not set
+# CONFIG_INPUT_TSLIBDEV is not set
+CONFIG_INPUT_EVDEV=m
+# CONFIG_INPUT_EVBUG is not set
+
+#
+# Input I/O drivers
+#
+# CONFIG_GAMEPORT is not set
+CONFIG_SOUND_GAMEPORT=y
+CONFIG_SERIO=y
+# CONFIG_SERIO_I8042 is not set
+CONFIG_SERIO_SERPORT=y
+# CONFIG_SERIO_CT82C710 is not set
+# CONFIG_SERIO_PCIPS2 is not set
+# CONFIG_SERIO_RAW is not set
+
+#
+# Input Device Drivers
+#
+CONFIG_INPUT_KEYBOARD=y
+CONFIG_KEYBOARD_ATKBD=y
+# CONFIG_KEYBOARD_SUNKBD is not set
+# CONFIG_KEYBOARD_LKKBD is not set
+# CONFIG_KEYBOARD_XTKBD is not set
+# CONFIG_KEYBOARD_NEWTON is not set
+CONFIG_INPUT_MOUSE=y
+CONFIG_MOUSE_PS2=y
+# CONFIG_MOUSE_SERIAL is not set
+# CONFIG_MOUSE_VSXXXAA is not set
+# CONFIG_INPUT_JOYSTICK is not set
+# CONFIG_INPUT_TOUCHSCREEN is not set
+# CONFIG_INPUT_MISC is not set
+
+#
+# Character devices
+#
+CONFIG_VT=y
+CONFIG_VT_CONSOLE=y
+CONFIG_HW_CONSOLE=y
+# CONFIG_SERIAL_NONSTANDARD is not set
+
+#
+# Serial drivers
+#
+# CONFIG_SERIAL_8250 is not set
+
+#
+# Non-8250 serial port support
+#
+CONFIG_SERIAL_MPSC=y
+CONFIG_SERIAL_MPSC_CONSOLE=y
+CONFIG_SERIAL_CORE=y
+CONFIG_SERIAL_CORE_CONSOLE=y
+CONFIG_UNIX98_PTYS=y
+CONFIG_LEGACY_PTYS=y
+CONFIG_LEGACY_PTY_COUNT=256
+
+#
+# IPMI
+#
+# CONFIG_IPMI_HANDLER is not set
+
+#
+# Watchdog Cards
+#
+CONFIG_WATCHDOG=y
+# CONFIG_WATCHDOG_NOWAYOUT is not set
+
+#
+# Watchdog Device Drivers
+#
+# CONFIG_SOFT_WATCHDOG is not set
+CONFIG_MV64X60_WDT=y
+
+#
+# PCI-based Watchdog Cards
+#
+# CONFIG_PCIPCWATCHDOG is not set
+# CONFIG_WDTPCI is not set
+# CONFIG_NVRAM is not set
+# CONFIG_BLOCKER is not set
+CONFIG_GEN_RTC=y
+# CONFIG_GEN_RTC_X is not set
+# CONFIG_DTLK is not set
+# CONFIG_R3964 is not set
+# CONFIG_APPLICOM is not set
+
+#
+# Ftape, the floppy tape device driver
+#
+# CONFIG_AGP is not set
+# CONFIG_DRM is not set
+# CONFIG_RAW_DRIVER is not set
+
+#
+# I2C support
+#
+CONFIG_I2C=y
+CONFIG_I2C_CHARDEV=y
+
+#
+# I2C Algorithms
+#
+# CONFIG_I2C_ALGOBIT is not set
+# CONFIG_I2C_ALGOPCF is not set
+# CONFIG_I2C_ALGOPCA is not set
+# CONFIG_I2C_ALGO_SGI is not set
+
+#
+# I2C Hardware Bus support
+#
+# CONFIG_I2C_ALI1535 is not set
+# CONFIG_I2C_ALI1563 is not set
+# CONFIG_I2C_ALI15X3 is not set
+# CONFIG_I2C_AMD756 is not set
+# CONFIG_I2C_AMD8111 is not set
+# CONFIG_I2C_I801 is not set
+# CONFIG_I2C_I810 is not set
+# CONFIG_I2C_ISA is not set
+# CONFIG_I2C_MPC is not set
+# CONFIG_I2C_NFORCE2 is not set
+# CONFIG_I2C_PARPORT_LIGHT is not set
+# CONFIG_I2C_PIIX4 is not set
+# CONFIG_I2C_PROSAVAGE is not set
+# CONFIG_I2C_SAVAGE4 is not set
+# CONFIG_SCx200_ACB is not set
+# CONFIG_I2C_SIS5595 is not set
+# CONFIG_I2C_SIS630 is not set
+# CONFIG_I2C_SIS96X is not set
+# CONFIG_I2C_STUB is not set
+# CONFIG_I2C_VIA is not set
+# CONFIG_I2C_VIAPRO is not set
+# CONFIG_I2C_VOODOO3 is not set
+# CONFIG_I2C_PCA_ISA is not set
+CONFIG_I2C_MV64XXX=y
+# CONFIG_I2C_OMAP is not set
+
+#
+# Hardware Sensors Chip support
+#
+CONFIG_I2C_SENSOR=y
+# CONFIG_SENSORS_ADM1021 is not set
+# CONFIG_SENSORS_ADM1025 is not set
+# CONFIG_SENSORS_ADM1026 is not set
+# CONFIG_SENSORS_ADM1031 is not set
+# CONFIG_SENSORS_ASB100 is not set
+# CONFIG_SENSORS_DS1621 is not set
+# CONFIG_SENSORS_FSCHER is not set
+# CONFIG_SENSORS_GL518SM is not set
+# CONFIG_SENSORS_IT87 is not set
+# CONFIG_SENSORS_LM63 is not set
+# CONFIG_SENSORS_LM75 is not set
+# CONFIG_SENSORS_LM77 is not set
+# CONFIG_SENSORS_LM78 is not set
+# CONFIG_SENSORS_LM80 is not set
+# CONFIG_SENSORS_LM83 is not set
+# CONFIG_SENSORS_LM85 is not set
+# CONFIG_SENSORS_LM87 is not set
+# CONFIG_SENSORS_LM90 is not set
+# CONFIG_SENSORS_MAX1619 is not set
+# CONFIG_SENSORS_PC87360 is not set
+# CONFIG_SENSORS_SMSC47M1 is not set
+# CONFIG_SENSORS_VIA686A is not set
+# CONFIG_SENSORS_W83781D is not set
+# CONFIG_SENSORS_W83L785TS is not set
+# CONFIG_SENSORS_W83627HF is not set
+
+#
+# Other I2C Chip support
+#
+# CONFIG_SENSORS_DS1374 is not set
+# CONFIG_SENSORS_DS1338 is not set
+CONFIG_SENSORS_EEPROM=y
+CONFIG_EEPROM_SIZE_BOOL=y
+CONFIG_EEPROM_SIZE=0x2000
+# CONFIG_SENSORS_PCF8574 is not set
+# CONFIG_SENSORS_PCF8591 is not set
+# CONFIG_SENSORS_RTC8564 is not set
+# CONFIG_SENSORS_M41T00 is not set
+CONFIG_SENSORS_MAX6900=y
+# CONFIG_TPS65010 is not set
+# CONFIG_I2C_DEBUG_CORE is not set
+# CONFIG_I2C_DEBUG_ALGO is not set
+# CONFIG_I2C_DEBUG_BUS is not set
+# CONFIG_I2C_DEBUG_CHIP is not set
+
+#
+# SPI support
+#
+# CONFIG_SPI is not set
+# CONFIG_SPI_MASTER is not set
+
+#
+# Dallas's 1-wire bus
+#
+# CONFIG_W1 is not set
+
+#
+# Misc devices
+#
+
+#
+# Multimedia Capabilities Port drivers
+#
+
+#
+# Multimedia devices
+#
+# CONFIG_VIDEO_DEV is not set
+
+#
+# Digital Video Broadcasting Devices
+#
+# CONFIG_DVB is not set
+
+#
+# Graphics support
+#
+# CONFIG_FB is not set
+
+#
+# Console display driver support
+#
+CONFIG_VGA_CONSOLE=y
+CONFIG_DUMMY_CONSOLE=y
+
+#
+# Sound
+#
+# CONFIG_SOUND is not set
+
+#
+# USB support
+#
+# CONFIG_USB is not set
+CONFIG_USB_ARCH_HAS_HCD=y
+CONFIG_USB_ARCH_HAS_OHCI=y
+
+#
+# Enable Host or Gadget support to see Inventra options
+#
+
+#
+# NOTE: USB_STORAGE enables SCSI, and 'SCSI disk support' may also be needed; see USB_STORAGE Help for more information
+#
+
+#
+# USB Gadget Support
+#
+# CONFIG_USB_GADGET is not set
+
+#
+# MMC/SD Card support
+#
+# CONFIG_MMC is not set
+
+#
+# Synchronous Serial Interfaces (SSI)
+#
+
+#
+# File systems
+#
+CONFIG_EXT2_FS=y
+# CONFIG_EXT2_FS_XATTR is not set
+CONFIG_EXT3_FS=m
+CONFIG_EXT3_FS_XATTR=y
+# CONFIG_EXT3_FS_POSIX_ACL is not set
+# CONFIG_EXT3_FS_SECURITY is not set
+CONFIG_JBD=m
+# CONFIG_JBD_DEBUG is not set
+CONFIG_FS_MBCACHE=y
+# CONFIG_REISERFS_FS is not set
+# CONFIG_JFS_FS is not set
+CONFIG_XFS_FS=m
+# CONFIG_XFS_RT is not set
+# CONFIG_XFS_QUOTA is not set
+# CONFIG_XFS_SECURITY is not set
+# CONFIG_XFS_POSIX_ACL is not set
+# CONFIG_MINIX_FS is not set
+# CONFIG_ROMFS_FS is not set
+# CONFIG_QUOTA is not set
+# CONFIG_DNOTIFY is not set
+# CONFIG_AUTOFS_FS is not set
+CONFIG_AUTOFS4_FS=m
+
+#
+# CD-ROM/DVD Filesystems
+#
+# CONFIG_ISO9660_FS is not set
+# CONFIG_UDF_FS is not set
+
+#
+# DOS/FAT/NT Filesystems
+#
+# CONFIG_MSDOS_FS is not set
+# CONFIG_VFAT_FS is not set
+# CONFIG_NTFS_FS is not set
+
+#
+# Pseudo filesystems
+#
+CONFIG_PROC_FS=y
+# CONFIG_PROC_KCORE is not set
+CONFIG_SYSFS=y
+# CONFIG_DEVFS_FS is not set
+# CONFIG_DEVPTS_FS_XATTR is not set
+CONFIG_TMPFS=y
+# CONFIG_TMPFS_XATTR is not set
+# CONFIG_HUGETLB_PAGE is not set
+CONFIG_RAMFS=y
+# CONFIG_RELAYFS_FS is not set
+
+#
+# Miscellaneous filesystems
+#
+# CONFIG_ADFS_FS is not set
+# CONFIG_AFFS_FS is not set
+# CONFIG_HFS_FS is not set
+# CONFIG_HFSPLUS_FS is not set
+# CONFIG_BEFS_FS is not set
+# CONFIG_BFS_FS is not set
+# CONFIG_EFS_FS is not set
+# CONFIG_JFFS_FS is not set
+CONFIG_JFFS2_FS=y
+CONFIG_JFFS2_FS_DEBUG=0
+# CONFIG_JFFS2_FS_WRITEBUFFER is not set
+# CONFIG_JFFS2_COMPRESSION_OPTIONS is not set
+CONFIG_JFFS2_ZLIB=y
+CONFIG_JFFS2_RTIME=y
+# CONFIG_JFFS2_RUBIN is not set
+CONFIG_CRAMFS=y
+# CONFIG_CRAMFS_LINEAR is not set
+# CONFIG_VXFS_FS is not set
+# CONFIG_HPFS_FS is not set
+# CONFIG_QNX4FS_FS is not set
+# CONFIG_SYSV_FS is not set
+# CONFIG_UFS_FS is not set
+# CONFIG_YAFFS_FS is not set
+# CONFIG_YAFFS1_FS is not set
+
+#
+# Network File Systems
+#
+CONFIG_NFS_FS=y
+CONFIG_NFS_V3=y
+# CONFIG_NFS_V4 is not set
+# CONFIG_NFS_DIRECTIO is not set
+CONFIG_NFSD=m
+CONFIG_NFSD_V3=y
+# CONFIG_NFSD_V4 is not set
+CONFIG_NFSD_TCP=y
+CONFIG_ROOT_NFS=y
+CONFIG_LOCKD=y
+CONFIG_LOCKD_V4=y
+CONFIG_EXPORTFS=m
+CONFIG_SUNRPC=y
+# CONFIG_RPCSEC_GSS_KRB5 is not set
+# CONFIG_RPCSEC_GSS_SPKM3 is not set
+CONFIG_SMB_FS=m
+# CONFIG_SMB_NLS_DEFAULT is not set
+# CONFIG_CIFS is not set
+# CONFIG_NCP_FS is not set
+# CONFIG_CODA_FS is not set
+# CONFIG_AFS_FS is not set
+
+#
+# Partition Types
+#
+# CONFIG_PARTITION_ADVANCED is not set
+CONFIG_MSDOS_PARTITION=y
+
+#
+# Native Language Support
+#
+CONFIG_NLS=m
+CONFIG_NLS_DEFAULT="iso8859-1"
+CONFIG_NLS_CODEPAGE_437=m
+# CONFIG_NLS_CODEPAGE_737 is not set
+# CONFIG_NLS_CODEPAGE_775 is not set
+# CONFIG_NLS_CODEPAGE_850 is not set
+# CONFIG_NLS_CODEPAGE_852 is not set
+# CONFIG_NLS_CODEPAGE_855 is not set
+# CONFIG_NLS_CODEPAGE_857 is not set
+# CONFIG_NLS_CODEPAGE_860 is not set
+# CONFIG_NLS_CODEPAGE_861 is not set
+# CONFIG_NLS_CODEPAGE_862 is not set
+# CONFIG_NLS_CODEPAGE_863 is not set
+# CONFIG_NLS_CODEPAGE_864 is not set
+# CONFIG_NLS_CODEPAGE_865 is not set
+# CONFIG_NLS_CODEPAGE_866 is not set
+# CONFIG_NLS_CODEPAGE_869 is not set
+# CONFIG_NLS_CODEPAGE_936 is not set
+# CONFIG_NLS_CODEPAGE_950 is not set
+# CONFIG_NLS_CODEPAGE_932 is not set
+# CONFIG_NLS_CODEPAGE_949 is not set
+# CONFIG_NLS_CODEPAGE_874 is not set
+# CONFIG_NLS_ISO8859_8 is not set
+# CONFIG_NLS_CODEPAGE_1250 is not set
+# CONFIG_NLS_CODEPAGE_1251 is not set
+CONFIG_NLS_ASCII=m
+CONFIG_NLS_ISO8859_1=m
+# CONFIG_NLS_ISO8859_2 is not set
+# CONFIG_NLS_ISO8859_3 is not set
+# CONFIG_NLS_ISO8859_4 is not set
+# CONFIG_NLS_ISO8859_5 is not set
+# CONFIG_NLS_ISO8859_6 is not set
+# CONFIG_NLS_ISO8859_7 is not set
+# CONFIG_NLS_ISO8859_9 is not set
+# CONFIG_NLS_ISO8859_13 is not set
+# CONFIG_NLS_ISO8859_14 is not set
+# CONFIG_NLS_ISO8859_15 is not set
+# CONFIG_NLS_KOI8_R is not set
+# CONFIG_NLS_KOI8_U is not set
+CONFIG_NLS_UTF8=m
+
+#
+# Library routines
+#
+CONFIG_CRC_CCITT=m
+CONFIG_CRC32=y
+# CONFIG_LIBCRC32C is not set
+CONFIG_ZLIB_INFLATE=y
+CONFIG_ZLIB_DEFLATE=y
+CONFIG_TOUCH_WATCHDOGS=y
+
+#
+# Fast Real-Time Domain
+#
+# CONFIG_FRD is not set
+
+#
+# Fast Real-Time Domain Advanced Options
+#
+
+#
+# Profiling support
+#
+# CONFIG_PROFILING is not set
+
+#
+# MontaVista System tools
+#
+# CONFIG_ILATENCY is not set
+
+#
+# Kernel hacking
+#
+# CONFIG_DEBUG_KERNEL is not set
+# CONFIG_DEBUG_PREEMPT is not set
+# CONFIG_WAKEUP_TIMING is not set
+# CONFIG_CRITICAL_PREEMPT_TIMING is not set
+# CONFIG_CRITICAL_IRQSOFF_TIMING is not set
+# CONFIG_SERIAL_TEXT_DEBUG is not set
+
+#
+# Security options
+#
+# CONFIG_KEYS is not set
+# CONFIG_SECURITY is not set
+
+#
+# Cryptographic options
+#
+# CONFIG_CRYPTO is not set
Index: linux-2.6.10/arch/ppc/platforms/Makefile
===================================================================
--- linux-2.6.10.orig/arch/ppc/platforms/Makefile
+++ linux-2.6.10/arch/ppc/platforms/Makefile
@@ -40,6 +40,7 @@ obj-$(CONFIG_PCORE)		+= pcore.o
 obj-$(CONFIG_POWERPMC250)	+= powerpmc250.o
 obj-$(CONFIG_PPLUS)		+= pplus.o
 obj-$(CONFIG_PQ2FADS)		+= pq2fads_setup.o
+obj-$(CONFIG_PRPMC275)		+= prpmc275.o
 obj-$(CONFIG_PRPMC750)		+= prpmc750.o
 obj-$(CONFIG_PRPMC800)		+= prpmc800.o
 obj-$(CONFIG_SANDPOINT)		+= sandpoint.o
Index: linux-2.6.10/arch/ppc/platforms/prpmc275.c
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/platforms/prpmc275.c
@@ -0,0 +1,817 @@
+/*
+ * arch/ppc/platforms/prpmc275.c
+ *
+ * Board setup routines for the Force PPMC275 Development Board.
+ *
+ * Athor: Vladimir A. Barinov <vbarinov@ru.mvista.com>
+ * 
+ * Based on code done by Rabeeh Khoury - rabeeh@galileo.co.il
+ * Based on code done by - Mark A. Greer <mgreer@mvista.com>
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ */
+
+#include <linux/config.h>
+#include <linux/stddef.h>
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/errno.h>
+#include <linux/reboot.h>
+#include <linux/pci.h>
+#include <linux/kdev_t.h>
+#include <linux/major.h>
+#include <linux/blkdev.h>
+#include <linux/console.h>
+#include <linux/root_dev.h>
+#include <linux/initrd.h>
+#include <linux/delay.h>
+#include <linux/irq.h>
+#include <linux/ide.h>
+#include <linux/seq_file.h>
+#include <linux/mtd/physmap.h>
+#include <linux/mv643xx.h>
+
+#include <asm/system.h>
+#include <asm/pgtable.h>
+#include <asm/page.h>
+#include <asm/hardirq.h>
+#include <asm/time.h>
+#include <asm/dma.h>
+#include <asm/io.h>
+#include <asm/machdep.h>
+#include <asm/prom.h>
+#include <asm/bootinfo.h>
+#include <asm/mv64x60.h>
+
+#include "prpmc275.h"
+
+static mv64x60_handle_t bh;
+
+static void __iomem *sram_base;	/* Virtual addr of Internal SRAM */
+
+static u32 prpmc275_flash_size_0;
+static u32 prpmc275_flash_size_1;
+
+#ifdef CONFIG_NONMONARCH_SUPPORT
+static int monarch = 0;
+
+static u8
+read_monarch_status(void)
+{
+	u32 temp;
+
+	/* Make sure that MV64360_MPP[4] is made MV64360_GPP[4] */
+
+	temp = mv64x60_read(&bh, MV64x60_MPP_CNTL_0);
+	temp = temp & 0xfff0ffff;
+	mv64x60_write(&bh, MV64x60_MPP_CNTL_0, temp);
+
+	/* Make sure that MV64360_GPP[4] is an Input pin */
+
+	temp = mv64x60_read(&bh, MV64x60_GPP_IO_CNTL);
+	temp = temp & 0xffffffef;
+	mv64x60_write(&bh, MV64x60_GPP_IO_CNTL, temp);
+
+	/* Make sure MV64360_GPP[4] is active high */
+	temp = mv64x60_read(&bh, MV64x60_GPP_LEVEL_CNTL);
+	temp = temp & 0xffffffef;
+	mv64x60_write(&bh, MV64x60_GPP_LEVEL_CNTL, temp);
+
+	/* Check wether MV is in monarch mode using MV64360_GPP[4] */
+
+	temp = mv64x60_read(&bh, MV64x60_GPP_VALUE);
+	if ((temp & 0x00000010) == 0x00000000)
+		return 1;
+	else
+		return 0;
+}
+
+static int
+prpmc275_pci_exclude_device(u8 bus, u8 devfn)
+{
+	struct pci_controller	*hose;
+
+	/*
+	 * Monarch is allowed to access all PCI devices. Non-monarch is
+	 * only allowed to access its own Marvell-64x60 chip.
+	 */
+	if (monarch)
+		return PCIBIOS_SUCCESSFUL;
+
+	hose = pci_bus_to_hose(bus);
+
+	if ((PCI_SLOT(devfn) == 0) && (hose->first_busno == bus))
+		return PCIBIOS_SUCCESSFUL;
+	else
+		return PCIBIOS_DEVICE_NOT_FOUND;
+}
+#endif
+
+/*
+ * DESCRIPTION: ppc_md memory size callback
+ */
+unsigned long __init
+ppmc275_find_end_of_memory(void)
+{
+	return mv64x60_get_mem_size(CONFIG_MV64X60_NEW_BASE,
+				    MV64x60_TYPE_MV64360);
+}
+
+/*
+ * Force PPMC275 Board PCI interrupt routing.
+ */
+static int __init
+ppmc275_map_irq(struct pci_dev *dev, unsigned char idsel, unsigned char pin)
+{
+	struct pci_controller *hose = pci_bus_to_hose(dev->bus->number);
+
+	if (hose->index == 0) {
+		static char pci_irq_table[][4] =
+		    /*
+		     *      PCI IDSEL/INTPIN->INTLINE 
+		     *         A   B   C   D
+		     */
+		{
+			/* IDSEL 1 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 2 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 3 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 4 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 5 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 6 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 7 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 8 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 9 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 10 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 11 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 12 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 13 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 14 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 15 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 16 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 17 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 18 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 19 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 20 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 21 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 22 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 23 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 24 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 25 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 26 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 27 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 28 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 29 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 30 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D},
+			/* IDSEL 31 - PCI bus 0 */
+			{PPMC275_PCI_0_IRQ, PPMC275_PCI_0_IRQ_B,
+			 PPMC275_PCI_0_IRQ_C, PPMC275_PCI_0_IRQ_D}
+		};
+
+		const long min_idsel = 1, max_idsel = 32, irqs_per_slot = 4;
+		return PCI_IRQ_TABLE_LOOKUP;
+	} else {
+		static char pci_irq_table[][4] =
+		    /*
+		     *      PCI IDSEL/INTPIN->INTLINE 
+		     *         A   B   C   D
+		     */
+		{
+			{PPMC275_PCI_1_IRQ, 0, 0, 0},	/* IDSEL 7 - PCI bus 1 */
+			{PPMC275_PCI_1_IRQ, 0, 0, 0},	/* IDSEL 8 - PCI bus 1 */
+			{PPMC275_PCI_1_IRQ, 0, 0, 0},	/* IDSEL 9 - PCI bus 1 */
+		};
+
+		const long min_idsel = 7, max_idsel = 9, irqs_per_slot = 4;
+		return PCI_IRQ_TABLE_LOOKUP;
+	}
+}
+
+static void __init
+ppmc275_setup_bridge(void)
+{
+	struct mv64x60_setup_info si;
+	int i;
+
+	if (ppc_md.progress)
+		ppc_md.progress("ppmc275_setup_bridge: enter", 0);
+
+	memset(&si, 0, sizeof (si));
+
+	si.phys_reg_base = CONFIG_MV64X60_NEW_BASE;
+
+	si.pci_0.enable_bus = 1;
+	si.pci_0.pci_io.cpu_base = PPMC275_PCI0_IO_START_PROC_ADDR;
+	si.pci_0.pci_io.pci_base_hi = 0;
+	si.pci_0.pci_io.pci_base_lo = PPMC275_PCI0_IO_START_PCI_ADDR;
+	si.pci_0.pci_io.size = PPMC275_PCI0_IO_SIZE;
+	si.pci_0.pci_io.swap = MV64x60_CPU2PCI_SWAP_NONE;
+	si.pci_0.pci_mem[0].cpu_base = PPMC275_PCI0_MEM_START_PROC_ADDR;
+	si.pci_0.pci_mem[0].pci_base_hi = PPMC275_PCI0_MEM_START_PCI_HI_ADDR;
+	si.pci_0.pci_mem[0].pci_base_lo = PPMC275_PCI0_MEM_START_PCI_LO_ADDR;
+	si.pci_0.pci_mem[0].size = PPMC275_PCI0_MEM_SIZE;
+	si.pci_0.pci_mem[0].swap = MV64x60_CPU2PCI_SWAP_NONE;
+	si.pci_0.pci_cmd_bits = 0;
+	si.pci_0.latency_timer = 0x80;
+
+	si.pci_1.enable_bus = 1;
+	si.pci_1.pci_io.cpu_base = PPMC275_PCI1_IO_START_PROC_ADDR;
+	si.pci_1.pci_io.pci_base_hi = 0;
+	si.pci_1.pci_io.pci_base_lo = PPMC275_PCI1_IO_START_PCI_ADDR;
+	si.pci_1.pci_io.size = PPMC275_PCI1_IO_SIZE;
+	si.pci_1.pci_io.swap = MV64x60_CPU2PCI_SWAP_NONE;
+	si.pci_1.pci_mem[0].cpu_base = PPMC275_PCI1_MEM_START_PROC_ADDR;
+	si.pci_1.pci_mem[0].pci_base_hi = PPMC275_PCI1_MEM_START_PCI_HI_ADDR;
+	si.pci_1.pci_mem[0].pci_base_lo = PPMC275_PCI1_MEM_START_PCI_LO_ADDR;
+	si.pci_1.pci_mem[0].size = PPMC275_PCI1_MEM_SIZE;
+	si.pci_1.pci_mem[0].swap = MV64x60_CPU2PCI_SWAP_NONE;
+	si.pci_1.pci_cmd_bits = 0;
+	si.pci_1.latency_timer = 0x80;
+
+	for (i = 0; i < MV64x60_CPU2MEM_WINDOWS; i++) {
+#if defined(CONFIG_NOT_COHERENT_CACHE)
+		si.cpu_prot_options[i] = 0;
+		si.enet_options[i] = MV64360_ENET2MEM_SNOOP_NONE;
+		si.mpsc_options[i] = MV64360_MPSC2MEM_SNOOP_NONE;
+		si.idma_options[i] = MV64360_IDMA2MEM_SNOOP_NONE;
+
+		si.pci_1.acc_cntl_options[i] =
+		    MV64360_PCI_ACC_CNTL_SNOOP_NONE |
+		    MV64360_PCI_ACC_CNTL_SWAP_NONE |
+		    MV64360_PCI_ACC_CNTL_MBURST_128_BYTES |
+		    MV64360_PCI_ACC_CNTL_RDSIZE_256_BYTES;
+#else
+		si.cpu_prot_options[i] = 0;
+		si.enet_options[i] = MV64360_ENET2MEM_SNOOP_NONE;	/* errata */
+		si.mpsc_options[i] = MV64360_MPSC2MEM_SNOOP_NONE;	/* errata */
+		si.idma_options[i] = MV64360_IDMA2MEM_SNOOP_NONE;	/* errata */
+
+		si.pci_1.acc_cntl_options[i] =
+		    MV64360_PCI_ACC_CNTL_SNOOP_WB |
+		    MV64360_PCI_ACC_CNTL_SWAP_NONE |
+		    MV64360_PCI_ACC_CNTL_MBURST_32_BYTES |
+		    MV64360_PCI_ACC_CNTL_RDSIZE_32_BYTES;
+#endif
+	}
+
+	/* Lookup PCI host bridges */
+	if (mv64x60_init(&bh, &si))
+		printk("Bridge initialization failed.\n");
+
+#ifdef CONFIG_NONMONARCH_SUPPORT
+	monarch = read_monarch_status();
+	printk(KERN_INFO "Running as %sMonarch\n", monarch ? "" : "Non-");
+	ppc_md.pci_exclude_device = prpmc275_pci_exclude_device;
+#endif
+
+	pci_dram_offset = 0;	/* sys mem at same addr on PCI & cpu bus */
+	ppc_md.pci_swizzle = common_swizzle;
+	ppc_md.pci_map_irq = ppmc275_map_irq;
+
+	mv64x60_set_bus(&bh, 0, 0);
+
+	bh.hose_a->first_busno = 0;
+	bh.hose_a->last_busno = 0xff;
+	bh.hose_a->last_busno = pciauto_bus_scan(bh.hose_a, 0);
+
+	bh.hose_b->first_busno = bh.hose_a->last_busno + 1;
+	mv64x60_set_bus(&bh, 1, bh.hose_b->first_busno);
+	bh.hose_b->last_busno = 0xff;
+	bh.hose_b->last_busno = pciauto_bus_scan(bh.hose_b,
+						 bh.hose_b->first_busno);
+}
+
+void __init
+ppmc275_setup_peripherals(void)
+{
+	u32 base, data;
+
+	mv64x60_set_32bit_window(&bh, MV64x60_CPU2BOOT_WIN,
+				 PPMC275_BOOT_FLASH_BASE,
+				 PPMC275_BOOT_FLASH_SIZE, 0);
+	bh.ci->enable_window_32bit(&bh, MV64x60_CPU2BOOT_WIN);
+
+	/* Assume firmware set up window sizes correctly for dev 0 & 1 */
+	mv64x60_get_32bit_window(&bh, MV64x60_CPU2DEV_0_WIN, &base,
+				 &prpmc275_flash_size_0);
+
+	if (prpmc275_flash_size_0 > 0) {
+		mv64x60_set_32bit_window(&bh, MV64x60_CPU2DEV_0_WIN,
+					 PPMC275_USER_FLASH_BASE,
+					 prpmc275_flash_size_0, 0);
+		bh.ci->enable_window_32bit(&bh, MV64x60_CPU2DEV_0_WIN);
+	}
+
+	mv64x60_get_32bit_window(&bh, MV64x60_CPU2DEV_1_WIN, &base,
+				 &prpmc275_flash_size_1);
+
+	if (prpmc275_flash_size_1 > 0) {
+		mv64x60_set_32bit_window(&bh, MV64x60_CPU2DEV_1_WIN,
+					 PPMC275_USER_FLASH_BASE +
+					 prpmc275_flash_size_0,
+					 prpmc275_flash_size_1, 0);
+		bh.ci->enable_window_32bit(&bh, MV64x60_CPU2DEV_1_WIN);
+	}
+
+	mv64x60_set_32bit_window(&bh, MV64x60_CPU2SRAM_WIN,
+				 PPMC275_INTERNAL_SRAM_BASE, MV64360_SRAM_SIZE,
+				 0);
+	bh.ci->enable_window_32bit(&bh, MV64x60_CPU2SRAM_WIN);
+
+#ifdef CONFIG_NOT_COHERENT_CACHE
+	mv64x60_write(&bh, MV64360_SRAM_CONFIG, 0x001600b0);
+#else
+	mv64x60_write(&bh, MV64360_SRAM_CONFIG, 0x001600b2);
+#endif
+
+	sram_base = ioremap(PPMC275_INTERNAL_SRAM_BASE, MV64360_SRAM_SIZE);
+	memset(sram_base, 0, MV64360_SRAM_SIZE);
+
+	/*
+	 * Enabling of PCI internal-vs-external arbitration
+	 * is a platform- and errata-dependent decision.
+	 */
+
+	mv64x60_set_bits(&bh, MV64x60_CPU_MASTER_CNTL, (1 << 9));
+
+	/* MPP 27,29 */
+	mv64x60_clr_bits(&bh, MV64x60_MPP_CNTL_3,
+			 (1 << 12) | (1 << 13) | (1 << 14) | (1 << 15) |
+			 (1 << 20) | (1 << 21) | (1 << 22) | (1 << 23));
+
+	/* MPP 16, MPP 17 */
+	mv64x60_clr_bits(&bh, MV64x60_MPP_CNTL_2,
+			 (1 << 0) | (1 << 1) | (1 << 2) | (1 << 3) | (1 << 4) |
+			 (1 << 5) | (1 << 6) | (1 << 7));
+
+	/* MPP 12, MPP 13 */
+	mv64x60_clr_bits(&bh, MV64x60_MPP_CNTL_1,
+			 (1 << 16) | (1 << 17) | (1 << 18) | (1 << 19) |
+			 (1 << 20) | (1 << 21) | (1 << 22) | (1 << 23));
+
+	/*
+	 * Define GPP 27 interrupt polarity as active low
+	 * input signal and level triggered
+	 */
+	mv64x60_set_bits(&bh, MV64x60_GPP_LEVEL_CNTL,
+			 (1 << 27) | (1 << 29) | (1 << 16) | (1 << 17) |
+			 (1 << 12) | (1 << 13));
+
+#ifdef CONFIG_NONMONARCH_SUPPORT
+	if (monarch) {
+		mv64x60_clr_bits(&bh, MV64x60_GPP_IO_CNTL,
+				 (1 << 27) | (1 << 29) | (1 << 16) | (1 << 17) |
+				 (1 << 12) | (1 << 13));
+	} else {
+		mv64x60_clr_bits(&bh, MV64x60_GPP_IO_CNTL,
+				 (1 << 12) | (1 << 13));
+
+		mv64x60_set_bits(&bh, MV64x60_GPP_IO_CNTL,
+				 (1 << 27) | (1 << 29) | (1 << 16) | (1 << 17));
+	}
+#else
+	mv64x60_clr_bits(&bh, MV64x60_GPP_IO_CNTL,
+			 (1 << 27) | (1 << 29) | (1 << 16) | (1 << 17) |
+			 (1 << 12) | (1 << 13));
+#endif
+
+	/* Config GPP interrupt controller to respond to level trigger */
+	mv64x60_set_bits(&bh, MV64x60_COMM_ARBITER_CNTL, (1 << 10));
+
+	/*
+	 * Dismiss and then enable interrupt on GPP interrupt cause for CPU #0
+	 */
+	mv64x60_write(&bh, MV64x60_GPP_INTR_CAUSE,
+		      ~((1 << 27) | (1 << 26) | (1 << 25)));
+	mv64x60_set_bits(&bh, MV64x60_GPP_INTR_MASK,
+			 (1 << 27) | (1 << 26) | (1 << 25));
+
+	/*
+	 * Dismiss and then enable interrupt on CPU #0 high cause register
+	 * BIT25 summarizes GPP interrupts 8-15 (Need MPP 12,13)
+	 * BIT26 summarizes GPP interrupts 16-23 (Need MPP 16,17)
+	 * BIT27 summarizes GPP interrupts 24-31 (Need MPP 27,29)
+	 */
+	mv64x60_set_bits(&bh, MV64360_IC_CPU0_INTR_MASK_HI,
+			 (1 << 27) | (1 << 26) | (1 << 25));
+
+	/*
+	 * Change DRAM read buffer assignment.
+	 * Assign read buffer 0 dedicated only for CPU, and the rest read buffer 1.
+	 */
+	data = mv64x60_read(&bh, MV64360_SDRAM_CONFIG);
+	data = data & 0x03ffffff;
+	data = data | 0xf8000000;
+	mv64x60_write(&bh, MV64360_SDRAM_CONFIG, data);
+}
+
+/* Second phase board init, called after other (architecture common)
+ * low-level services have been initialized.
+  */
+static void
+prpmc275_init2(void)
+{
+	u32 data;
+
+#ifdef CONFIG_MV64X60_WDT
+	/* Configure MPP19 as watchdog WDE */
+	data = mv64x60_read(&bh, MV64x60_MPP_CNTL_2);
+	data &= ~(0xf << 12);
+	data |= (0x4 << 12);
+	mv64x60_write(&bh, MV64x60_MPP_CNTL_2, data);
+
+	/* Configure, MPP24 as watchdog NMI */
+	data = mv64x60_read(&bh, MV64x60_MPP_CNTL_3);
+	data &= ~(0xf << 0);
+	data |= (0x4 << 0);
+	mv64x60_write(&bh, MV64x60_MPP_CNTL_3, data);
+
+	/* Make sure WatchDog is disabled */
+	data = mv64x60_read(&bh, MV64x60_WDT_WDC);
+	if (data & (1 << 31)) {
+		data &= ~(0x3 << 24);
+		data |= (0x1 << 24);
+		mv64x60_write(&bh, MV64x60_WDT_WDC, data);
+		data &= ~(0x3 << 24);
+		data |= (0x2 << 24);
+		mv64x60_write(&bh, MV64x60_WDT_WDC, data);
+	}
+#endif
+}
+
+#ifdef CONFIG_MTD_PHYSMAP
+static struct mtd_partition prpmc275_partitions[] = {
+	{
+	 .name = "Kernel",
+	 .offset = 0,
+	 .size = 0x300000,
+	 },
+	{
+	 .name = "Filesystem",
+	 .offset = MTDPART_OFS_APPEND,
+	 .size = 0x1600000,
+	 },
+	{
+	 .name = "JFFS2",
+	 .offset = MTDPART_OFS_APPEND,
+	 .size = MTDPART_SIZ_FULL,
+	 }
+};
+
+static int __init
+prpmc275_setup_mtd(void)
+{
+	u32 size;
+
+	size = prpmc275_flash_size_0 + prpmc275_flash_size_1;
+	if (!size)
+		return -ENOMEM;
+
+	if (size > PPMC275_USER_FLASH_SIZE)
+		size = PPMC275_USER_FLASH_SIZE;
+
+	physmap_configure(PPMC275_USER_FLASH_BASE, size, 4, NULL);
+	physmap_set_partitions(prpmc275_partitions,
+			       sizeof (prpmc275_partitions) /
+			       sizeof (struct mtd_partition));
+
+	return 0;
+}
+
+arch_initcall(prpmc275_setup_mtd);
+#endif
+
+static void __init
+ppmc275_setup_arch(void)
+{
+	if (ppc_md.progress)
+		ppc_md.progress("ppmc275_setup_arch: enter", 0);
+
+	loops_per_jiffy = 50000000 / HZ;
+
+#ifdef CONFIG_BLK_DEV_INITRD
+	if (initrd_start)
+		ROOT_DEV = Root_RAM0;
+	else
+#endif
+#ifdef	CONFIG_ROOT_NFS
+		ROOT_DEV = Root_NFS;
+#else
+		ROOT_DEV = Root_SDA2;
+#endif
+
+	/* Enable L2 cache */
+	_set_L2CR(_get_L2CR() | L2CR_L2E);
+
+#ifdef	CONFIG_DUMMY_CONSOLE
+	conswitchp = &dummy_con;
+#endif
+
+	ppmc275_setup_bridge();
+	ppmc275_setup_peripherals();
+
+	if (ppc_md.progress)
+		ppc_md.progress("ppmc275_setup_arch: exit", 0);
+
+	return;
+}
+
+/* Platform device data fixup routines. */
+#if defined(CONFIG_SERIAL_MPSC)
+static void __init
+ppmc275_fixup_mpsc_pdata(struct platform_device *pdev)
+{
+	struct mpsc_pdata *pdata;
+	pdata = (struct mpsc_pdata *) pdev->dev.platform_data;
+
+	pdata->max_idle = 40;
+	pdata->default_baud = PPMC275_DEFAULT_BAUD;
+	pdata->brg_clk_src = PPMC275_MPSC_CLK_SRC;
+	pdata->brg_clk_freq = PPMC275_BUS_FREQ;
+}
+#endif
+
+#if defined(CONFIG_SENSORS_EEPROM)
+static struct {
+	char *bus_id;
+	u16 eeprom_size;
+} eeprom_map[] = {
+	{"0-0052", 8192},
+	{"0-0053", 8192},
+	{"0-0054", 8192},
+};
+
+static void __init
+ppmc275_fixup_eeprom_pdata(struct platform_device *pdev)
+{
+	int i;
+
+	for (i = 0; i < ARRAY_SIZE(eeprom_map); i++)
+		if (!strncmp(pdev->dev.bus_id, eeprom_map[i].bus_id,
+			     BUS_ID_SIZE)) {
+			pdev->dev.platform_data = &eeprom_map[i].eeprom_size;
+		}
+}
+#endif
+
+static int __init
+ppmc275_platform_notify(struct device *dev)
+{
+	static struct {
+		char *bus_id;
+		void ((*rtn) (struct platform_device * pdev));
+	} dev_map[] = {
+#if defined(CONFIG_SERIAL_MPSC)
+		{
+		MPSC_CTLR_NAME ".0", ppmc275_fixup_mpsc_pdata}, {
+		MPSC_CTLR_NAME ".1", ppmc275_fixup_mpsc_pdata},
+#endif
+#if defined(CONFIG_SENSORS_EEPROM)
+		{"0-0052", ppmc275_fixup_eeprom_pdata},
+		{"0-0053", ppmc275_fixup_eeprom_pdata},
+		{"0-0054", ppmc275_fixup_eeprom_pdata},
+#endif
+	};
+
+	struct platform_device *pdev;
+	int i;
+	if (dev && dev->bus_id)
+		for (i = 0; i < ARRAY_SIZE(dev_map); i++)
+			if (!strncmp(dev->bus_id, dev_map[i].bus_id,
+				     BUS_ID_SIZE)) {
+				pdev = container_of(dev,
+						    struct platform_device,
+						    dev);
+				dev_map[i].rtn(pdev);
+			}
+
+	return 0;
+}
+
+static void
+ppmc275_restart(char *cmd)
+{
+	volatile ulong i = 10000000;
+	unsigned int gpio_io_ctrl;
+	unsigned int mpp_ctrl_02, save;
+
+	local_irq_disable();
+
+	/* Set exception prefix high - to the firmware */
+	_nmask_and_or_msr(0, MSR_IP);
+
+	printk("mv64360_reset_board: begin\n");
+
+	mpp_ctrl_02 = mv64x60_read(&bh, MV64x60_MPP_CNTL_2);
+	mpp_ctrl_02 &= 0xffff0fff;
+	mv64x60_write(&bh, MV64x60_MPP_CNTL_2, mpp_ctrl_02);
+
+	gpio_io_ctrl = mv64x60_read(&bh, MV64x60_GPP_IO_CNTL);
+	gpio_io_ctrl |= 0x00080000;
+	mv64x60_write(&bh, MV64x60_GPP_IO_CNTL, gpio_io_ctrl);
+
+	save = gpio_io_ctrl = mv64x60_read(&bh, MV64x60_GPP_LEVEL_CNTL);
+	gpio_io_ctrl |= 0x00080000;
+	mv64x60_write(&bh, MV64x60_GPP_LEVEL_CNTL, gpio_io_ctrl);
+
+	while (i-- > 0) ;
+	mv64x60_write(&bh, MV64x60_GPP_LEVEL_CNTL, save);
+	panic("restart failed\n");
+}
+
+static void
+ppmc275_halt(void)
+{
+	local_irq_disable();
+	while (1) ;
+}
+
+static void
+ppmc275_power_off(void)
+{
+	ppmc275_halt();
+}
+
+static int
+ppmc275_show_cpuinfo(struct seq_file *m)
+{
+	uint pvid;
+
+	pvid = mfspr(PVR);
+	seq_printf(m, "vendor\t\t: Marvell/Galileo\n");
+	seq_printf(m, "machine\t\t: PPMC-275\n");
+	seq_printf(m, "PVID\t\t: 0x%x, vendor: %s\n",
+		   pvid, (pvid & (1 << 15) ? "IBM" : "Motorola"));
+
+	return 0;
+}
+
+static void __init
+ppmc275_calibrate_decr(void)
+{
+	ulong freq;
+
+	freq = PPMC275_BUS_FREQ / 4;
+
+	printk("time_init: decrementer frequency = %lu.%.6lu MHz\n",
+	       freq / 1000000, freq % 1000000);
+
+	tb_ticks_per_jiffy = freq / HZ;
+	tb_to_us = mulhwu_scale_factor(freq, 1000000);
+	us_to_tb = freq / 1000000;
+
+	return;
+}
+
+/*
+ * Configure fixed memory-mapped IO
+ */
+static void __init
+ppmc275_map_io(void)
+{
+#if defined(CONFIG_SERIAL_TEXT_DEBUG) || defined(CONFIG_KGDB_MPSC)
+	io_block_mapping(CONFIG_MV64X60_NEW_BASE, CONFIG_MV64X60_NEW_BASE,
+			 0x100000, _PAGE_IO);
+#endif
+}
+
+#if defined(CONFIG_I2C_MV64XXX) && defined(CONFIG_SENSORS_MAX6900)
+extern ulong max6900_get_rtc_time(void);
+extern int max6900_set_rtc_time(ulong);
+
+static int __init
+prpmc275_rtc_hookup(void)
+{
+	struct timespec tv;
+
+	ppc_md.get_rtc_time = max6900_get_rtc_time;
+	ppc_md.set_rtc_time = max6900_set_rtc_time;
+
+	tv.tv_nsec = 0;
+	tv.tv_sec = (ppc_md.get_rtc_time) ();
+
+	do_settimeofday(&tv);
+
+	return 0;
+}
+
+late_initcall(prpmc275_rtc_hookup);
+#endif
+
+/*
+ * Set BAT 3 to map 0xf0000000 to end of physical memory space.
+ * This configures a (temporary) bat mapping for early access to
+ * device I/O
+ */
+static __inline__ void
+ppmc275_set_bat(void)
+{
+	mb();
+	mtspr(DBAT3U, 0xf0001ffe);
+	mtspr(DBAT3L, 0xf000002a);
+	mb();
+}
+
+void __init
+platform_init(unsigned long r3, unsigned long r4, unsigned long r5,
+	      unsigned long r6, unsigned long r7)
+{
+	parse_bootinfo(find_bootinfo());
+
+	isa_mem_base = 0;
+
+	ppc_md.setup_arch = ppmc275_setup_arch;
+	ppc_md.show_cpuinfo = ppmc275_show_cpuinfo;
+	ppc_md.irq_canonicalize = NULL;
+	ppc_md.init_IRQ = mv64360_init_irq;
+	ppc_md.get_irq = mv64360_get_irq;
+	ppc_md.init = prpmc275_init2;
+	ppc_md.restart = ppmc275_restart;
+	ppc_md.power_off = ppmc275_power_off;
+	ppc_md.halt = ppmc275_halt;
+	ppc_md.find_end_of_memory = ppmc275_find_end_of_memory;
+	ppc_md.calibrate_decr = ppmc275_calibrate_decr;
+	ppc_md.setup_io_mappings = ppmc275_map_io;
+
+	ppmc275_set_bat();
+
+#if defined(CONFIG_SERIAL_TEXT_DEBUG)
+	ppc_md.progress = mv64x60_mpsc_progress;
+	mv64x60_progress_init(CONFIG_MV64X60_NEW_BASE);
+#endif
+
+#if defined(CONFIG_SERIAL_MPSC)
+	platform_notify = ppmc275_platform_notify;
+#endif
+
+#ifdef CONFIG_BLK_DEV_INITRD
+	if (r4) {
+		initrd_start = r4 + KERNELBASE;
+		initrd_end = r5 + KERNELBASE;
+	}
+#endif				/* CONFIG_BLK_DEV_INITRD */
+
+	return;
+}
Index: linux-2.6.10/arch/ppc/platforms/prpmc275.h
===================================================================
--- /dev/null
+++ linux-2.6.10/arch/ppc/platforms/prpmc275.h
@@ -0,0 +1,91 @@
+/*
+ * arch/ppc/platforms/prpmc275.h
+ * 
+ * Definitions for Force PPMC275 development board.
+ *
+ * Vladimir A. Barinov <vbrinov@ru.mvista.com>
+ *
+ * Based on code done by Rabeeh Khoury - rabeeh@galileo.co.il
+ * Based on code done by Mark A. Greer <mgreer@mvista.com>
+ *
+ * This program is free software; you can redistribute  it and/or modify it
+ * under  the terms of  the GNU General  Public License as published by the
+ * Free Software Foundation;  either version 2 of the  License, or (at your
+ * option) any later version.
+ */
+
+/*
+ * The MV64360 has 2 PCI buses each with 1 window from the CPU bus to
+ * PCI I/O space and 4 windows from the CPU bus to PCI MEM space.
+ * We'll only use one PCI MEM window on each PCI bus.
+ *
+ * This is the CPU physical memory map (windows must be at least 1MB and start
+ * on a boundary that is a multiple of the window size):
+ *	
+ *	PPMC275 MEM MAP			
+ *
+ *	0xff800000-0xffffffff		- Boot flash (BootCS#)
+ *	0xf2040000-0xff7fffff		- Unused
+ * 	0xf2000000-0xf203ffff		- Integrated SRAM
+ * 	0xf1010000-0xf1ffffff		- Unused
+ * 	0xf1000000-0xf100ffff		- MV64360 Registers
+ * 	0xa8000000-0xf0ffffff		- Unused
+ * 	0xa4000000-0xa7ffffff		- User flash expansion
+ * 	0xa2000000-0xa3ffffff		- User flash 1 ( CS1)
+ * 	0xa0000000-0xa1ffffff           - User flash 0 ( CS0)
+ * 	0x99000000-0x9fffffff		- <hole>
+ * 	0x98000000-0x98ffffff		- PCI 1 I/O (defined in mv64360.h)
+ * 	0x90000000-0x97ffffff		- PCI 1 MEM (defined in mv64360.h)
+ * 	0x88000000-0x88ffffff		- PCI 0 I/O (defined in mv64360.h)
+ * 	0x80000000-0x87ffffff		- PCI 0 MEM (defined in mv64360.h)
+ *	0x20000000-0x7fffffff		- Reserved for SDRAM expansion
+ * 	0x00000000-0x1fffffff		- On Board SDRAM ( CS0)
+ */
+
+#ifndef __PPC_PLATFORMS_PPMC275_H
+#define __PPC_PLATFORMS_PPMC275_H
+
+/*
+ * CPU Physical Memory Map setup.
+ */
+
+#define PPMC275_BOOT_FLASH_BASE			0xff800000
+#define PPMC275_USER_FLASH_BASE			0xa0000000
+#define PPMC275_INTERNAL_SRAM_BASE		0xf2000000
+
+#define PPMC275_BOOT_FLASH_SIZE			0x00100000	/* 1MB of Embed FLASH */
+#define PPMC275_USER_FLASH_SIZE			0x08000000	/* <= 128 MB Extern FLASH */
+
+#define PPMC275_BUS_FREQ			133333333
+
+#define PPMC275_DEFAULT_BAUD			115200
+#define PPMC275_MPSC_CLK_SRC			8	/* TCLK */
+
+#define PPMC275_PCI0_MEM_START_PROC_ADDR        0x80000000
+#define PPMC275_PCI0_MEM_START_PCI_HI_ADDR      0x00000000
+#define PPMC275_PCI0_MEM_START_PCI_LO_ADDR      0x80000000
+#define PPMC275_PCI0_MEM_SIZE                   0x08000000
+#define PPMC275_PCI0_IO_START_PCI_ADDR          0x00000000
+#define PPMC275_PCI0_IO_SIZE                    0x01000000
+
+#define PPMC275_PCI1_MEM_START_PROC_ADDR        0x90000000
+#define PPMC275_PCI1_MEM_START_PCI_HI_ADDR      0x00000000
+#define PPMC275_PCI1_MEM_START_PCI_LO_ADDR      0x90000000
+#define PPMC275_PCI1_MEM_SIZE                   0x08000000
+#define PPMC275_PCI1_IO_START_PCI_ADDR          0x01000000
+#define PPMC275_PCI1_IO_SIZE                    0x01000000
+
+#define PPMC275_PCI0_IO_START_PROC_ADDR         (PPMC275_PCI0_MEM_START_PROC_ADDR + PPMC275_PCI0_MEM_SIZE)
+#define PPMC275_PCI1_IO_START_PROC_ADDR         (PPMC275_PCI1_MEM_START_PROC_ADDR + PPMC275_PCI1_MEM_SIZE)
+
+/*
+ * Board-specific IRQ info
+ */
+#define PPMC275_PCI_0_IRQ               64+27
+#define PPMC275_PCI_0_IRQ_B             64+29
+#define PPMC275_PCI_0_IRQ_C             64+16
+#define PPMC275_PCI_0_IRQ_D             64+17
+
+#define PPMC275_PCI_1_IRQ               64+30
+
+#endif				/* __PPC_PLATFORMS_PPMC275_H */
Index: linux-2.6.10/arch/ppc/syslib/Makefile
===================================================================
--- linux-2.6.10.orig/arch/ppc/syslib/Makefile
+++ linux-2.6.10/arch/ppc/syslib/Makefile
@@ -76,6 +76,7 @@ obj-$(CONFIG_PCORE)		+= todc_time.o i825
 obj-$(CONFIG_POWERPMC250)	+= pci_auto.o
 obj-$(CONFIG_PPLUS)		+= hawk_common.o open_pic.o i8259.o \
 				   indirect_pci.o todc_time.o pci_auto.o
+obj-$(CONFIG_PRPMC275)		+= pci_auto.o 
 obj-$(CONFIG_PRPMC750)		+= open_pic.o indirect_pci.o pci_auto.o \
 					hawk_common.o
 obj-$(CONFIG_HARRIER)		+= harrier.o
Index: linux-2.6.10/mvl_patches/pro-0946.c
===================================================================
--- /dev/null
+++ linux-2.6.10/mvl_patches/pro-0946.c
@@ -0,0 +1,16 @@
+/*
+ * Author: MontaVista Software, Inc. <source@mvista.com>
+ *
+ * 2006 (c) MontaVista Software, Inc. This file is licensed under
+ * the terms of the GNU General Public License version 2. This program
+ * is licensed "as is" without any warranty of any kind, whether express
+ * or implied.
+ */
+#include <linux/init.h>
+#include <linux/mvl_patch.h>
+
+static __init int regpatch(void)
+{
+        return mvl_register_patch(946);
+}
+module_init(regpatch);
EOF

    rv=0
    cat /tmp/mvl_patch_$$
    if [ "$?" != "0" ]; then
	# Patch had a hard error, return 2
	rv=2
    elif grep '^Hunk' ${TMPFILE}; then
	rv=1
    fi

    rm -f ${TMPFILE}
    return $rv
}

function options() {
    echo "Options are:"
    echo "  --force-unsupported - Force the patch to be applied even if the"
    echo "      patch is out of order or the current kernel is unsupported."
    echo "      Use of this option is strongly discouraged."
    echo "  --force-apply-fuzz - If the patch has fuzz, go ahead and apply"
    echo "      it anyway.  This can occur if the patch is applied to an"
    echo "      unsupported kernel or applied out of order or if you have"
    echo "      made your own modifications to the kernel.  Use with"
    echo "      caution."
    echo "  --remove - Remove the patch"
}


function checkpatchnum() {
    local level;

    if [ ! -e ${1} ]; then
	echo "${1} does not exist, make sure you are in the kernel" 1>&2
	echo "base directory" 1>&2
	exit 1;
    fi

    # Extract the current patch number from the lsp info file.
    level=`grep '#define LSP_.*PATCH_LEVEL' ${1} | sed 's/^.*\"\\(.*\\)\".*\$/\\1/'`
    if [ "a$level" = "a" ]; then
	echo "No patch level defined in ${1}, are you sure this is" 1>&2
	echo "a valid MVL kernel LSP?" 1>&2
	exit 1;
    fi

    expr $level + 0 >/dev/null 2>&1
    isnum=$?

    # Check if the kernel is supported
    if [ "$level" = "unsupported" ]; then
	echo "**Current kernel is unsupported by MontaVista due to patches"
	echo "  begin applied out of order."
	if [ $force_unsupported == 't' ]; then
	    echo "  Application is forced, applying patch anyway"
	    unsupported=t
	    fix_patch_level=f
	else
	    echo "  Patch application aborted.  Use --force-unsupported to"
	    echo "  force the patch to be applied, but the kernel will not"
	    echo "  be supported by MontaVista."
	    exit 1;
	fi

    # Check the patch number from the lspinfo file to make sure it is
    # a valid number
    elif [ $isnum = 2 ]; then
	echo "**Patch level from ${1} was not a valid number, " 1>&2
	echo "  are you sure this is a valid MVL kernel LSP?" 1>&2
	exit 1;

    # Check that this is the right patch number to be applied.
    elif [ `expr $level $3` ${4} ${2} ]; then
	echo "**Application of this patch is out of order and will cause the"
	echo "  kernel to be unsupported by MontaVista."
	if [ $force_unsupported == 't' ]; then
	    echo "  application is forced, applying patch anyway"
	    unsupported=t
	else
	    echo "  Patch application aborted.  Please get all the patches in"
	    echo "  proper order from MontaVista Zone and apply them in order"
	    echo "  If you really want to apply this patch, use"
	    echo "  --force-unsupported to force the patch to be applied, but"
	    echo "  the kernel will not be supported by MontaVista."
	    exit 1;
	fi
    fi
}

#
# Update the patch level in the file.  Note that we use patch to do
# this.  Certain weak version control systems don't take kindly to
# arbitrary changes directly to files, but do have a special version
# of "patch" that understands this.
#
function setpatchnum() {
    sed "s/^#define LSP_\(.*\)PATCH_LEVEL[ \t*]\"[0-9]*\".*$/#define LSP_\1PATCH_LEVEL \"${2}\"/" <${1} >/tmp/$$.tmp1
    diff -u ${1} /tmp/$$.tmp1 >/tmp/$$.tmp2
    rm /tmp/$$.tmp1
    sed "s/^+++ \/tmp\/$$.tmp1/+++ include\/linux\/lsppatchlevel.h/" </tmp/$$.tmp2 >/tmp/$$.tmp1
    rm /tmp/$$.tmp2
    patch -p0 </tmp/$$.tmp1
    rm /tmp/$$.tmp1
}

force_unsupported=f
force_apply_fuzz=""
unsupported=f
fix_patch_level=t
reverse=f
common_patchnum_diff='+ 1'
common_patchnum=$PATCHNUM
patch_extraopts=''

# Extract command line parameters.
while [ $# -gt 0 ]; do
    if [ "a$1" == 'a--force-unsupported' ]; then
	force_unsupported=t
    elif [ "a$1" == 'a--force-apply-fuzz' ]; then
	force_apply_fuzz=y
    elif [ "a$1" == 'a--remove' ]; then
	reverse=t
	common_patchnum_diff=''
	common_patchnum=`expr $PATCHNUM - 1`
	patch_extraopts='--reverse'
    else
	echo "'$1' is an invalid command line parameter."
	options
	exit 1
    fi
    shift
done

echo "Checking patch level"
checkpatchnum ${LSPINFO} ${PATCHNUM} "${common_patchnum_diff}" "-ne"

if ! dopatch -p1 --dry-run --force $patch_extraopts; then
    if [ $? = 2 ]; then
	echo -n "**Patch had errors, application aborted" 1>&2
	exit 1;
    fi

    # Patch has warnings
    clean_apply=${force_apply_fuzz}
    while [ "a$clean_apply" != 'ay' -a "a$clean_apply" != 'an' ]; do
	echo -n "**Patch did not apply cleanly.  Do you still want to apply? (y/n) > "
	read clean_apply
	clean_apply=`echo "$clean_apply" | tr '[:upper:]' '[:lower:]'`
    done
    if [ $clean_apply = 'n' ]; then
	exit 1;
    fi
fi

dopatch -p1 --force $patch_extraopts

if [ $fix_patch_level = 't' ]; then 
    if [ $unsupported = 't' ]; then
	common_patchnum="unsupported"
    fi

    setpatchnum ${LSPINFO} ${common_patchnum}
fi

# Move the patch file into the mvl_patches directory if we are not reversing
if [ $reverse != 't' ]; then 
    if echo $0 | grep '/' >/dev/null; then
	# Filename is a path, either absolute or from the current directory.
	srcfile=$0
    else
	# Filename is from the path
	for i in `echo $PATH | tr ':;' '  '`; do
	    if [ -e ${i}/$0 ]; then
		srcfile=${i}/$0
	    fi
	done
    fi

    fname=`basename ${srcfile}`
    diff -uN mvl_patches/${fname} ${srcfile} | (cd mvl_patches; patch)
fi

